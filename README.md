#Artmosphere
<img src="https://github.com/keiraqz/artmosphere/blob/master/img/cover.png" alt="alt text" width="600" height="300">


#Table of Contents
- <a href= "https://github.com/keiraqz/artmosphere/blob/master/README.md#introduction">Introduction</a>
- <a href= "https://github.com/keiraqz/artmosphere/blob/master/README.md#settings">Settings</a>
- <a href= "https://github.com/keiraqz/artmosphere/blob/master/README.md#data-processing">Data Processing</a>
- <a href= "https://github.com/keiraqz/artmosphere/blob/master/README.md#live-demo">Live Demo</a>
- <a href= "https://github.com/keiraqz/artmosphere/blob/master/README.md#presentation-deck">Presentation Deck</a>
- <a href= "https://github.com/keiraqz/artmosphere/blob/master/README.md#instructions-to-run-this-pipeline">Instructions to Run this Pipeline</a>


#Introduction
This is a data engineering project at <a href= "http://insightdataengineering.com/">Insight Data Engineering Fellow Program</a>. The project provides a platform for users to search for different artworks, see similar art pieces and real-time popularity of a given art piece. Users can also see where all the artworks have been uploaded across the world. The main goal of the program to learn different tools used in a data pipeline for processing large datasets in a distributed manner.


**Tools used:**
- Data ingestion: <a href= "http://kafka.apache.org/">Kafka</a>
- Data storage: <a href= "https://hadoop.apache.org/">Hadoop Distributed File System</a>
- Batch processing: <a href= "https://spark.apache.org/">Spark</a>
- Real-time processing: <a href= "https://spark.apache.org/streaming/">Spark Streaming</a>
- Database: <a href= "https://www.elastic.co/products/elasticsearch">Elasticsearch</a>, <a href= "http://cassandra.apache.org/">Cassandra</a>
- Web API: <a href= "http://flask.pocoo.org/">Flask</a>
- Website: <a href= "http://getbootstrap.com/">Bootstrap</a>, <a href= "http://www.highcharts.com/">Highcharts</a>


#Settings
**Dataset:**

The dataset is a collection of 26,000 artworks and 45,000 artists collected from <a href= "https://www.artsy.net/">Artsy.net</a> in JSON format. In order to simulate real-time user activities, the project also used self-engineered data in two formats:
- Collecting: user\_id, collected, artwork\_id
- Uploading: user\id, uploaded, artwork\_id, location\_code


**AWS Clusters:**
A distributed AWS cluster of 4 EC2 machines is being used for this project. All the components (ingestion, batch and real-time processing) are configured and run in distributed mode, with 1 master node and 3 slave nodes.


#Data Processing
<img src="https://github.com/PreetikaKuls/Insight-MapMyCab/blob/master/images/pipeline.png" alt="alt text" width="600" height="300">

- **Data Ingestion (Kafka):** The raw data is consumed by a message broker, configured in publish-subscribe mode. 
  - Each cab ID is assigned a separate key in order to preserve the temporal ordering of data for each cab (kafka guarantees in order delivery within each partition, and all data for a particular key would reside in one partition). 
  - All keys are published into a common topic. Related files: <a href= "https://github.com/PreetikaKuls/Insight-MapMyCab/blob/master/kafka/producer.py">producer.py</a>, <a href= "https://github.com/PreetikaKuls/Insight-MapMyCab/blob/master/kafka/kafka_consumer.py">kafka_consumer.py</a>.

- **Batch Layer (HDFS, Hadoop):** A kafka consumer stores the data into HDFS. Additional columns are added to the dataset to generate metrics as described in the ensuing section. This is accomplished using Hive (and MrJob). Following this, tables representing the aggregate views for serving queries at the user end are generated using Hive.

- **Serving Layer (HBase):** Datastore tables store the aggregate views for hour of day, day of week and individual cab profiles as generated by Hive. The table schema is optimized for quick access, by storing the hours as columns and the totals for each day in the same row (this way, hourly and daily profiles can be served from the same table/rows).

- **Speed Layer (Storm):** The topology for processing real-time data comprises of a kafka-spout and a bolt (with tick interval frequency of 5 sec). The data is filtered to only store currently available (unoccupied) cabs into HBase. In order to serve queries with low latency, all the data is stored in one row (maximum possible columns = number of cabs = 500). For future work, the data can be stored with the key as city, so that all cabs pertaining to a city can be retrieved via one row. If the number of cabs is large, further breakdown on city_zipcode (as key) will enable quick access, while retaining the advantage of quick row scans in HBase.

- **Front-end (Flask):** The cab locations are rendered on Google Maps and updated at 2 sec interval via AJAX. Historical data is represented as bar and line charts. Realted files: <a href= "https://github.com/PreetikaKuls/Insight-MapMyCab/blob/master/flask/app/views.py">views.py</a>, <a href= "https://github.com/PreetikaKuls/Insight-MapMyCab/blob/master/flask/app/static/batch.js">batch.js</a>, <a href="https://github.com/PreetikaKuls/Insight-MapMyCab/blob/master/flask/app/static/map.js">map.js</a>.

- **Libraries and APIs:** Happybase, Pyleus, Kafka-python


#Live Demo:
A Live Demo of the project is available here: www.mapmycab.org
A snap shot of the map with cabs:


<img src="https://github.com/PreetikaKuls/Insight-MapMyCab/blob/master/images/realtime.png" alt="alt text" width="500" height="300">

#Presentation Deck
The presentation slides are available here:
<a href= "http://54.183.182.89:5000/aboutme">www.mapmycab.org/aboutme</a>

#Instructions to Run this Pipeline

Install python packages:
```sudo pip install kafka-python happybase pyleus mrjob```

Run the Kafka producer / consumer:
```python kafka/producer.py```
```python kafka/kafka_consumer.py```

Run MrJob:
```python mr_hourly_job.py -r hadoop --hadoop-bin /usr/bin/hadoop hdfs:///<input file path> -o <output file path>```

Run Hive Scripts
```hive -f <filename>```

Build storm topology:
```pyleus build cab_topology.yaml```

Submit pyleus topology:
```pyleus submit -n 54.153.51.200 cab_topology.jar```






